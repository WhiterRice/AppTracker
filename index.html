<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Application Tracker</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 300;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .form-section, .applications-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #e1e8ed;
        }

        .form-section h2, .applications-section h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-weight: 600;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #34495e;
            font-size: 14px;
        }

        input, select, textarea {
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }

        .applications-list {
            max-height: none;
        }

        .job-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }

        .job-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .job-card.editing {
            background: #fff8dc;
            border-left-color: #f39c12;
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .job-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .company-name {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .job-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 12px;
            font-weight: 600;
            color: #7f8c8d;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .detail-value {
            color: #2c3e50;
            font-weight: 500;
        }

        .status-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            text-align: center;
        }

        .status-pending { background: #f0f4f8; color: #546e7a; }
        .status-applied { background: #e8f4fd; color: #1976d2; }
        .status-screening { background: #fff3e0; color: #f57c00; }
        .status-interview { background: #f3e5f5; color: #7b1fa2; }
        .status-offer { background: #fff8e1; color: #ff8f00; }

        .outcome-declined { background: #ffebee; color: #d32f2f; }
        .outcome-rejected { background: #fce4ec; color: #c2185b; }
        .outcome-withdrawn { background: #f5f5f5; color: #616161; }
        .outcome-ghosted { background: #f5f5f5; color: #616161; }
        .outcome-accepted { background: #e8f5e8; color: #388e3c; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .stat-number {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .visualization-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #e1e8ed;
        }

        .sankey-title {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.5em;
            font-weight: 600;
        }

        #sankey {
            width: 100%;
            height: 500px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }

        .edit-select, .edit-input {
            padding: 8px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            width: 100%;
        }

        .edit-select:focus, .edit-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .job-details {
                grid-template-columns: 1fr;
            }
        }

        .node rect {
            cursor: move;
            fill-opacity: .9;
            shape-rendering: crispEdges;
        }

        .node text {
            pointer-events: none;
            text-shadow: 0 1px 0 #fff;
            font-size: 12px;
        }

        .link {
            fill: none;
            stroke: #000;
            stroke-opacity: .2;
        }

        .link:hover {
            stroke-opacity: .5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¯ Job Application Tracker</h1>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalJobs">0</div>
                <div class="stat-label">Total Applications</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeJobs">0</div>
                <div class="stat-label">Active</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="interviewJobs">0</div>
                <div class="stat-label">Interviews</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="offerJobs">0</div>
                <div class="stat-label">Offers</div>
            </div>
        </div>

        <div class="form-section">
            <h2>Add New Application</h2>
            <form id="applicationForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="company">Company Name *</label>
                        <input type="text" id="company" required>
                    </div>
                    <div class="form-group">
                        <label for="position">Position *</label>
                        <input type="text" id="position" required>
                    </div>
                    <div class="form-group">
                        <label for="salary">Salary Range</label>
                        <input type="text" id="salary" placeholder="e.g., $80k-$100k">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="rto">RTO Policy</label>
                        <select id="rto">
                            <option value="">Not specified</option>
                            <option value="Full Remote">Full Remote</option>
                            <option value="Hybrid">Hybrid</option>
                            <option value="Full In-Office">Full In-Office</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="progress">Progress Status *</label>
                        <select id="progress" required>
                            <option value="">Select Progress</option>
                            <option value="Pending">Pending</option>
                            <option value="Applied">Applied</option>
                            <option value="Screening">Screening</option>
                            <option value="Interview">Interview</option>
                            <option value="Offer">Offer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="outcome">Final Outcome</label>
                        <select id="outcome">
                            <option value="">None/In Progress</option>
                            <option value="Declined">Declined</option>
                            <option value="Rejected">Rejected</option>
                            <option value="Withdrawn">Withdrawn</option>
                            <option value="Ghosted">Ghosted</option>
                            <option value="Accepted">Accepted</option>
                        </select>
                    </div>
                </div>
                
                <button type="submit" class="btn">Add Application</button>
                <button type="button" class="btn" onclick="clearForm()">Clear Form</button>
            </form>
        </div>

        <div class="applications-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin-bottom: 0;">Applications</h2>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label for="sortOptions" style="margin-bottom: 0; font-size: 14px;">Sort by:</label>
                    <select id="sortOptions" onchange="tracker.setSortOption(this.value)" style="width: auto; min-width: 200px;">
                        <option value="created-desc">Created Date (Newest First)</option>
                        <option value="created-asc">Created Date (Oldest First)</option>
                        <option value="updated-desc">Last Updated (Newest First)</option>
                        <option value="updated-asc">Last Updated (Oldest First)</option>
                        <option value="company-asc">Company Name (A-Z)</option>
                        <option value="company-desc">Company Name (Z-A)</option>
                        <option value="position-asc">Position (A-Z)</option>
                        <option value="position-desc">Position (Z-A)</option>
                    </select>
                </div>
            </div>
            <div class="applications-list" id="applicationsList">
            </div>
        </div>

        <div class="visualization-section">
            <div class="sankey-title">Application Flow Visualization</div>
            <svg id="sankey"></svg>
        </div>

        <div class="form-section">
            <h2>Import / Export Data</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="importFile">Import Applications (JSON)</label>
                    <input type="file" id="importFile" accept=".json" style="margin-bottom: 10px;">
                    <div style="margin-top: 8px;">
                        <button type="button" class="btn" onclick="importApplications()">Import from File</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Export Applications</label>
                    <div style="display: flex; gap: 10px; margin-top: 8px;">
                        <button type="button" class="btn" onclick="exportApplications()">Export to JSON</button>
                        <button type="button" class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class JobApplicationTracker {
            constructor() {
                this.applications = this.loadApplications();
                this.editingAppId = null;
                this.sortOption = 'created-desc'; // Default sort
                this.initializeEventListeners();
                this.renderApplications();
                this.updateStats();
                this.updateVisualization();
            }

            initializeEventListeners() {
                document.getElementById('applicationForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addApplication();
                });
            }

            addApplication() {
                const company = document.getElementById('company').value.trim();
                const position = document.getElementById('position').value.trim();
                const salary = document.getElementById('salary').value.trim();
                const rto = document.getElementById('rto').value;
                const progress = document.getElementById('progress').value;
                const outcome = document.getElementById('outcome').value;

                if (!company || !position || !progress) {
                    alert('Please fill in all required fields');
                    return;
                }

                const application = {
                    id: Date.now(),
                    company,
                    position,
                    salary,
                    rto,
                    progress,
                    outcome,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                this.applications.push(application);
                this.saveApplications();
                this.renderApplications();
                this.updateStats();
                this.updateVisualization();
                document.getElementById('applicationForm').reset();
            }

            deleteApplication(id) {
                if (confirm('Are you sure you want to delete this job application?')) {
                    this.applications = this.applications.filter(app => app.id !== id);
                    this.saveApplications();
                    this.renderApplications();
                    this.updateStats();
                    this.updateVisualization();
                }
            }

            editApplication(id) {
                this.editingAppId = id;
                this.renderApplications();
            }

            saveApplication(id) {
                const salaryInput = document.getElementById(`salary-${id}`);
                const rtoSelect = document.getElementById(`rto-${id}`);
                const progressSelect = document.getElementById(`progress-${id}`);
                const outcomeSelect = document.getElementById(`outcome-${id}`);
                
                const app = this.applications.find(app => app.id === id);
                if (app) {
                    app.salary = salaryInput.value.trim();
                    app.rto = rtoSelect.value;
                    app.progress = progressSelect.value;
                    app.outcome = outcomeSelect.value;
                    app.updatedAt = new Date().toISOString();
                    
                    this.editingAppId = null;
                    this.saveApplications();
                    this.renderApplications();
                    this.updateStats();
                    this.updateVisualization();
                }
            }

            cancelEdit() {
                this.editingAppId = null;
                this.renderApplications();
            }

            setSortOption(sortOption) {
                this.sortOption = sortOption;
                this.renderApplications();
            }

            sortApplications(applications) {
                const sorted = [...applications];
                
                switch (this.sortOption) {
                    case 'created-desc':
                        return sorted.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    case 'created-asc':
                        return sorted.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    case 'updated-desc':
                        return sorted.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));
                    case 'updated-asc':
                        return sorted.sort((a, b) => new Date(a.updatedAt || a.createdAt) - new Date(b.updatedAt || b.createdAt));
                    case 'company-asc':
                        return sorted.sort((a, b) => a.company.toLowerCase().localeCompare(b.company.toLowerCase()));
                    case 'company-desc':
                        return sorted.sort((a, b) => b.company.toLowerCase().localeCompare(a.company.toLowerCase()));
                    case 'position-asc':
                        return sorted.sort((a, b) => a.position.toLowerCase().localeCompare(b.position.toLowerCase()));
                    case 'position-desc':
                        return sorted.sort((a, b) => b.position.toLowerCase().localeCompare(a.position.toLowerCase()));
                    default:
                        return sorted.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                }
            }

            renderApplications() {
                const container = document.getElementById('applicationsList');
                
                if (this.applications.length === 0) {
                    container.innerHTML = '<div class="job-card"><h3>No job applications yet. Add your first one above!</h3></div>';
                    return;
                }

                // Sort applications based on current sort option
                const sortedApplications = this.sortApplications(this.applications);
                
                container.innerHTML = sortedApplications.map(app => {
                    const progressClass = `status-${app.progress.toLowerCase()}`;
                    const outcomeClass = app.outcome ? `outcome-${app.outcome.toLowerCase()}` : '';
                    const isEditing = this.editingAppId === app.id;
                    
                    if (isEditing) {
                        return `
                            <div class="job-card editing">
                                <div class="job-header">
                                    <div>
                                        <div class="job-title">${app.position}</div>
                                        <div class="company-name">${app.company}</div>
                                    </div>
                                </div>
                                
                                <div class="job-details">
                                    <div class="detail-item">
                                        <div class="detail-label">Salary Range</div>
                                        <input id="salary-${app.id}" class="edit-input" value="${app.salary || ''}" placeholder="e.g., $80k-$100k">
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">RTO Policy</div>
                                        <select id="rto-${app.id}" class="edit-select">
                                            <option value="" ${!app.rto ? 'selected' : ''}>Not specified</option>
                                            <option value="Full Remote" ${app.rto === 'Full Remote' ? 'selected' : ''}>Full Remote</option>
                                            <option value="Hybrid" ${app.rto === 'Hybrid' ? 'selected' : ''}>Hybrid</option>
                                            <option value="Full In-Office" ${app.rto === 'Full In-Office' ? 'selected' : ''}>Full In-Office</option>
                                        </select>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">Progress Status</div>
                                        <select id="progress-${app.id}" class="edit-select">
                                            <option value="Pending" ${app.progress === 'Pending' ? 'selected' : ''}>Pending</option>
                                            <option value="Applied" ${app.progress === 'Applied' ? 'selected' : ''}>Applied</option>
                                            <option value="Screening" ${app.progress === 'Screening' ? 'selected' : ''}>Screening</option>
                                            <option value="Interview" ${app.progress === 'Interview' ? 'selected' : ''}>Interview</option>
                                            <option value="Offer" ${app.progress === 'Offer' ? 'selected' : ''}>Offer</option>
                                        </select>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">Final Outcome</div>
                                        <select id="outcome-${app.id}" class="edit-select">
                                            <option value="" ${!app.outcome ? 'selected' : ''}>In Progress</option>
                                            <option value="Declined" ${app.outcome === 'Declined' ? 'selected' : ''}>Declined</option>
                                            <option value="Rejected" ${app.outcome === 'Rejected' ? 'selected' : ''}>Rejected</option>
                                            <option value="Withdrawn" ${app.outcome === 'Withdrawn' ? 'selected' : ''}>Withdrawn</option>
                                            <option value="Ghosted" ${app.outcome === 'Ghosted' ? 'selected' : ''}>Ghosted</option>
                                            <option value="Accepted" ${app.outcome === 'Accepted' ? 'selected' : ''}>Accepted</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 20px;">
                                    <button class="btn" onclick="tracker.saveApplication(${app.id})">Save Changes</button>
                                    <button class="btn" onclick="tracker.cancelEdit()">Cancel</button>
                                </div>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="job-card">
                                <div class="job-header">
                                    <div>
                                        <div class="job-title">${app.position}</div>
                                        <div class="company-name">${app.company}</div>
                                    </div>
                                    <div>
                                        <span class="status-badge ${progressClass}">${app.progress}</span>
                                        ${app.outcome ? `<span class="status-badge ${outcomeClass}">${app.outcome}</span>` : ''}
                                    </div>
                                </div>
                                
                                <div class="job-details">
                                    ${app.salary ? `<div class="detail-item"><div class="detail-label">Salary</div><div class="detail-value">${app.salary}</div></div>` : ''}
                                    ${app.rto ? `<div class="detail-item"><div class="detail-label">RTO Policy</div><div class="detail-value">${app.rto}</div></div>` : ''}
                                    <div class="detail-item"><div class="detail-label">Created</div><div class="detail-value">${new Date(app.createdAt).toLocaleDateString()}</div></div>
                                    ${app.updatedAt && app.updatedAt !== app.createdAt ? `<div class="detail-item"><div class="detail-label">Last Updated</div><div class="detail-value">${new Date(app.updatedAt).toLocaleDateString()}</div></div>` : ''}
                                    <div class="detail-item"><div class="detail-label">Status</div><div class="detail-value">${app.outcome || 'In Progress'}</div></div>
                                </div>
                                
                                <div style="margin-top: 20px;">
                                    <button class="btn" onclick="tracker.editApplication(${app.id})">Edit Application</button>
                                    <button class="btn btn-danger" onclick="tracker.deleteApplication(${app.id})">Delete</button>
                                </div>
                            </div>
                        `;
                    }
                }).join('');
            }

            updateStats() {
                const total = this.applications.length;
                const active = this.applications.filter(app => !['Declined', 'Rejected', 'Withdrawn', 'Ghosted'].includes(app.outcome)).length;
                const interviews = this.applications.filter(app => app.progress === 'Interview').length;
                const offers = this.applications.filter(app => app.progress === 'Offer' || app.outcome === 'Accepted').length;

                document.getElementById('totalJobs').textContent = total;
                document.getElementById('activeJobs').textContent = active;
                document.getElementById('interviewJobs').textContent = interviews;
                document.getElementById('offerJobs').textContent = offers;
            }

            updateVisualization() {
                this.createSankeyDiagram();
            }

            createSankeyDiagram() {
                const svg = d3.select("#sankey");
                svg.selectAll("*").remove();

                if (this.applications.length === 0) {
                    svg.append("text")
                        .attr("x", "50%")
                        .attr("y", "50%")
                        .attr("text-anchor", "middle")
                        .attr("dominant-baseline", "middle")
                        .style("font-size", "16px")
                        .style("fill", "#666")
                        .text("No applications to visualize");
                    return;
                }

                const width = parseInt(svg.style("width"));
                const height = parseInt(svg.style("height"));
                const margin = { top: 20, right: 20, bottom: 20, left: 20 };

                const progressStages = ['Pending', 'Applied', 'Screening', 'Interview', 'Offer'];
                const outcomes = ['Declined', 'Withdrawn', 'Ghosted', 'Accepted'];

                const nodes = [];
                const links = [];

                // Add progress stages as main flow nodes
                progressStages.forEach((stage, index) => {
                    nodes.push({ id: stage, name: stage, category: 'progress' });
                });

                // Add Accepted as a main flow continuation (after Offer)
                nodes.push({ id: 'Accepted', name: 'Accepted', category: 'progress' });

                // Add terminating outcomes (not including Accepted since it's in main flow)
                const terminatingOutcomes = ['Declined', 'Rejected', 'Withdrawn', 'Ghosted'];
                terminatingOutcomes.forEach(outcome => {
                    nodes.push({ id: outcome, name: outcome, category: 'outcome' });
                });

                const flowCounts = {};

                this.applications.forEach(app => {
                    const progressIndex = progressStages.indexOf(app.progress);
                    
                    // Track flows through all stages up to current progress
                    for (let i = 0; i < progressIndex; i++) {
                        const from = progressStages[i];
                        const to = progressStages[i + 1];
                        const key = `${from}->${to}`;
                        flowCounts[key] = (flowCounts[key] || 0) + 1;
                    }

                    // Handle outcomes
                    if (app.outcome) {
                        if (app.outcome === 'Accepted') {
                            // If accepted, first flow to Offer (if not already there), then to Accepted
                            if (app.progress !== 'Offer') {
                                const key = `${app.progress}->Offer`;
                                flowCounts[key] = (flowCounts[key] || 0) + 1;
                            }
                            const acceptedKey = `Offer->Accepted`;
                            flowCounts[acceptedKey] = (flowCounts[acceptedKey] || 0) + 1;
                        } else {
                            // Other outcomes flow directly from current progress stage
                            const key = `${app.progress}->${app.outcome}`;
                            flowCounts[key] = (flowCounts[key] || 0) + 1;
                        }
                    } else if (app.progress === 'Offer') {
                        // If at Offer stage with no outcome, it's still in progress
                        // Don't create any terminating flow
                    }
                });

                Object.entries(flowCounts).forEach(([key, value]) => {
                    const [source, target] = key.split('->');
                    links.push({
                        source: nodes.findIndex(n => n.id === source),
                        target: nodes.findIndex(n => n.id === target),
                        value: value
                    });
                });

                const sankey = d3.sankey()
                    .nodeWidth(15)
                    .nodePadding(10)
                    .extent([[margin.left, margin.top], [width - margin.right, height - margin.bottom]]);

                const { nodes: sankeyNodes, links: sankeyLinks } = sankey({
                    nodes: nodes.map(d => ({ ...d })),
                    links: links.map(d => ({ ...d }))
                });

                const stageColors = {
                    'Pending': '#546e7a',
                    'Applied': '#1976d2',
                    'Screening': '#f57c00',
                    'Interview': '#7b1fa2',
                    'Offer': '#ff8f00',
                    'Declined': '#d32f2f',
                    'Rejected': '#c2185b',
                    'Withdrawn': '#616161',
                    'Ghosted': '#616161',
                    'Accepted': '#388e3c'
                };

                const color = (d) => stageColors[d.name] || '#666';

                // Create gradients for nodes
                const defs = svg.append("defs");
                Object.entries(stageColors).forEach(([name, baseColor]) => {
                    const gradient = defs.append("linearGradient")
                        .attr("id", `nodeGradient-${name}`)
                        .attr("x1", "0%")
                        .attr("y1", "0%")
                        .attr("x2", "0%")
                        .attr("y2", "100%");
                    
                    gradient.append("stop")
                        .attr("offset", "0%")
                        .attr("stop-color", d3.color(baseColor).brighter(0.3))
                        .attr("stop-opacity", "0.9");
                    
                    gradient.append("stop")
                        .attr("offset", "100%")
                        .attr("stop-color", baseColor)
                        .attr("stop-opacity", "0.9");
                });

                const g = svg.append("g");

                // Draw links with gradients
                g.append("g")
                    .selectAll("path")
                    .data(sankeyLinks)
                    .join("path")
                    .attr("d", d3.sankeyLinkHorizontal())
                    .attr("fill", "none")
                    .attr("stroke", d => {
                        const sourceColor = color(d.source);
                        const targetColor = color(d.target);
                        
                        // Create a gradient for each link
                        const linkGradient = defs.append("linearGradient")
                            .attr("id", `linkGradient-${d.source.name}-${d.target.name}`)
                            .attr("gradientUnits", "userSpaceOnUse")
                            .attr("x1", d.source.x1)
                            .attr("x2", d.target.x0);
                        
                        linkGradient.append("stop")
                            .attr("offset", "0%")
                            .attr("stop-color", sourceColor)
                            .attr("stop-opacity", "0.6");
                        
                        linkGradient.append("stop")
                            .attr("offset", "100%")
                            .attr("stop-color", targetColor)
                            .attr("stop-opacity", "0.6");
                        
                        return `url(#linkGradient-${d.source.name}-${d.target.name})`;
                    })
                    .attr("stroke-width", d => Math.max(2, d.width))
                    .style("opacity", 0.7)
                    .on("mouseover", function(event, d) {
                        d3.select(this)
                            .style("opacity", 0.9)
                            .attr("stroke-width", d => Math.max(3, d.width + 1));
                    })
                    .on("mouseout", function(event, d) {
                        d3.select(this)
                            .style("opacity", 0.7)
                            .attr("stroke-width", d => Math.max(2, d.width));
                    })
                    .append("title")
                    .text(d => `${d.source.name} â†’ ${d.target.name}: ${d.value}`);

                // Draw nodes with gradients and enhanced styling
                g.append("g")
                    .selectAll("rect")
                    .data(sankeyNodes)
                    .join("rect")
                    .attr("x", d => d.x0)
                    .attr("y", d => d.y0)
                    .attr("height", d => d.y1 - d.y0)
                    .attr("width", d => d.x1 - d.x0)
                    .attr("fill", d => `url(#nodeGradient-${d.name})`)
                    .attr("rx", 6)
                    .attr("ry", 6)
                    .style("filter", "drop-shadow(0px 2px 4px rgba(0,0,0,0.1))")
                    .on("mouseover", function() {
                        d3.select(this)
                            .style("filter", "drop-shadow(0px 4px 8px rgba(0,0,0,0.2))")
                            .transition()
                            .duration(200)
                            .attr("rx", 8)
                            .attr("ry", 8);
                    })
                    .on("mouseout", function() {
                        d3.select(this)
                            .style("filter", "drop-shadow(0px 2px 4px rgba(0,0,0,0.1))")
                            .transition()
                            .duration(200)
                            .attr("rx", 6)
                            .attr("ry", 6);
                    })
                    .append("title")
                    .text(d => `${d.name}: ${d.value}`);

                // Draw node labels with better styling
                g.append("g")
                    .selectAll("text")
                    .data(sankeyNodes)
                    .join("text")
                    .attr("x", d => d.x0 < width / 2 ? d.x1 + 8 : d.x0 - 8)
                    .attr("y", d => (d.y1 + d.y0) / 2)
                    .attr("dy", "0.35em")
                    .attr("text-anchor", d => d.x0 < width / 2 ? "start" : "end")
                    .text(d => `${d.name} (${d.value})`)
                    .style("font-size", "13px")
                    .style("font-weight", "600")
                    .style("fill", "#2c3e50")
                    .style("text-shadow", "0 1px 2px rgba(255,255,255,0.8)");
            }

            saveApplications() {
                localStorage.setItem('jobApplications', JSON.stringify(this.applications));
            }

            loadApplications() {
                const saved = localStorage.getItem('jobApplications');
                return saved ? JSON.parse(saved) : [];
            }
        }

        function clearForm() {
            document.getElementById('applicationForm').reset();
        }

        function exportApplications() {
            const applications = tracker.applications;
            if (applications.length === 0) {
                alert('No applications to export!');
                return;
            }

            const dataStr = JSON.stringify(applications, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `job-applications-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function importApplications() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a JSON file to import.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate the data structure
                    if (!Array.isArray(importedData)) {
                        throw new Error('Invalid format: Expected an array of applications');
                    }
                    
                    // Validate each application has required fields
                    const requiredFields = ['company', 'position', 'progress'];
                    importedData.forEach((app, index) => {
                        requiredFields.forEach(field => {
                            if (!app[field]) {
                                throw new Error(`Invalid application at index ${index}: Missing required field '${field}'`);
                            }
                        });
                        
                        // Ensure each application has an ID, createdAt, and updatedAt
                        if (!app.id) {
                            app.id = Date.now() + index;
                        }
                        if (!app.createdAt) {
                            app.createdAt = new Date().toISOString();
                        }
                        if (!app.updatedAt) {
                            app.updatedAt = app.createdAt;
                        }
                    });
                    
                    // Ask user if they want to replace or merge data
                    const replaceData = tracker.applications.length === 0 || 
                        confirm('Do you want to replace existing applications? Click Cancel to merge with existing data.');
                    
                    if (replaceData) {
                        tracker.applications = importedData;
                    } else {
                        // Merge data, avoiding duplicates based on company and position
                        importedData.forEach(newApp => {
                            const exists = tracker.applications.some(existingApp => 
                                existingApp.company === newApp.company && 
                                existingApp.position === newApp.position
                            );
                            if (!exists) {
                                tracker.applications.push(newApp);
                            }
                        });
                    }
                    
                    tracker.saveApplications();
                    tracker.renderApplications();
                    tracker.updateStats();
                    tracker.updateVisualization();
                    
                    alert(`Successfully imported ${importedData.length} applications!`);
                    fileInput.value = ''; // Clear the file input
                    
                } catch (error) {
                    alert(`Import failed: ${error.message}`);
                }
            };
            
            reader.readAsText(file);
        }

        function clearAllData() {
            if (tracker.applications.length === 0) {
                alert('No data to clear!');
                return;
            }
            
            if (confirm('Are you sure you want to delete ALL job applications? This cannot be undone.')) {
                tracker.applications = [];
                tracker.saveApplications();
                tracker.renderApplications();
                tracker.updateStats();
                tracker.updateVisualization();
                alert('All application data has been cleared.');
            }
        }

        const tracker = new JobApplicationTracker();
    </script>
</body>
</html>